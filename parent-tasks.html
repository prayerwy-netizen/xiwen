<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»åŠ¡ç®¡ç† - æ›¦æ–‡ç¤¼ç‰©å…‘æ¢ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="css/common.css?v=5">
  <link rel="stylesheet" href="css/components.css?v=5">
  <style>
    body {
      background: var(--bg-light);
      padding-bottom: 80px;
    }

    .page-content {
      padding: var(--spacing-lg) var(--spacing-md);
      max-width: 800px;
      margin: 0 auto;
    }

    .action-bar {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .task-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-normal);
      padding: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      transition: all var(--transition-normal) ease;
    }

    .task-card.disabled {
      opacity: 0.5;
    }

    .task-toggle {
      width: 44px;
      height: 24px;
      background: #D9D9D9;
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background var(--transition-normal) ease;
    }

    .task-toggle.enabled {
      background: var(--success-color);
    }

    .task-toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--white);
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left var(--transition-normal) ease;
    }

    .task-toggle.enabled::after {
      left: 22px;
    }

    .task-info {
      flex: 1;
    }

    .task-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: 4px;
    }

    .task-name {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-dark);
    }

    .task-type-badge {
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
    }

    .task-type-badge.positive {
      background: #F6FFED;
      color: var(--success-color);
    }

    .task-type-badge.negative {
      background: #FFF1F0;
      color: var(--error-color);
    }

    .task-details {
      font-size: 14px;
      color: var(--text-medium);
    }

    .task-score {
      font-weight: 600;
      color: var(--gold-color);
      font-family: var(--font-mono);
    }

    .task-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .task-action-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      background: var(--bg-light);
      color: var(--primary-color);
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-normal) ease;
    }

    .task-action-btn:active {
      background: var(--primary-color);
      color: var(--white);
    }

    .task-action-btn.delete {
      color: var(--error-color);
    }

    .task-action-btn.delete:active {
      background: var(--error-color);
      color: var(--white);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }

    @media (max-width: 767px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="top-nav">
    <div class="top-nav-left">
      <button onclick="window.location.href='parent-record.html'">â—€ è¿”å›</button>
    </div>
    <div class="top-nav-title">ä»»åŠ¡ç®¡ç†</div>
    <div class="top-nav-right">
      <button onclick="utils.exitParentMode()">é€€å‡º</button>
    </div>
  </div>

  <div class="page-content">
    <div class="action-bar">
      <button class="btn-primary" style="flex: 1;" onclick="showAddTaskModal()">â• æ–°å¢ä»»åŠ¡</button>
    </div>

    <div class="tasks-list" id="tasksList"></div>

    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-state-icon">ğŸ“</div>
      <div class="empty-state-text">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œå¿«æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</div>
    </div>
  </div>

  <!-- åº•éƒ¨èœå• -->
  <div class="parent-menu">
    <button class="menu-btn" onclick="window.location.href='parent-record.html'">å¿«é€Ÿè®°è´¦</button>
    <button class="menu-btn" onclick="window.location.href='parent-gifts.html'">ç¤¼ç‰©ç®¡ç†</button>
    <button class="menu-btn" onclick="window.location.href='parent-approval.html'">å…‘æ¢å®¡æ‰¹</button>
    <button class="menu-btn" onclick="window.location.href='parent-settings.html'">è®¾ç½®</button>
  </div>

  <!-- Supabase å®¢æˆ·ç«¯åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabase é…ç½® -->
  <script src="js/supabase-config.js?v=1"></script>
  <script src="js/common.js?v=5"></script>
  <script>
    utils.requireParentMode();

    let tasks = [];

    // åˆå§‹åŒ–
    function init() {
      loadTasks();
    }

    // åŠ è½½ä»»åŠ¡åˆ—è¡¨
    function loadTasks() {
      tasks = dataManager.getTasks();
      renderTasks();
    }

    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    function renderTasks() {
      const tasksList = document.getElementById('tasksList');
      const emptyState = document.getElementById('emptyState');

      if (tasks.length === 0) {
        tasksList.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      tasksList.innerHTML = '';

      tasks.forEach(task => {
        const card = document.createElement('div');
        card.className = `task-card ${task.enabled ? '' : 'disabled'}`;

        const typeText = task.type === 'positive' ? 'æ­£å‘' : 'è´Ÿå‘';
        const typeClass = task.type === 'positive' ? 'positive' : 'negative';

        card.innerHTML = `
          <div class="task-toggle ${task.enabled ? 'enabled' : ''}" onclick="toggleTask(${task.id})"></div>
          <div class="task-info">
            <div class="task-header">
              <div class="task-name">${task.name}</div>
              <div class="task-type-badge ${typeClass}">${typeText}</div>
            </div>
            <div class="task-details">
              ${task.unit} Â· <span class="task-score">${task.score}åˆ†</span>
            </div>
          </div>
          <div class="task-actions">
            <button class="task-action-btn" onclick="editTask(${task.id})">âœï¸</button>
            <button class="task-action-btn delete" onclick="deleteTask(${task.id})">ğŸ—‘ï¸</button>
          </div>
        `;

        tasksList.appendChild(card);
      });
    }

    // åˆ‡æ¢ä»»åŠ¡å¯ç”¨çŠ¶æ€
    function toggleTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      task.enabled = !task.enabled;
      dataManager.updateTask(task);
      loadTasks();
      utils.showToast(task.enabled ? 'ä»»åŠ¡å·²å¯ç”¨' : 'ä»»åŠ¡å·²ç¦ç”¨');
    }

    // æ˜¾ç¤ºæ–°å¢ä»»åŠ¡å¼¹çª—
    function showAddTaskModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <h3 class="modal-title">æ–°å¢ä»»åŠ¡</h3>
          <form id="taskForm" onsubmit="submitTask(event)">
            <div class="form-group">
              <label class="form-label form-label-required">ä»»åŠ¡åç§°</label>
              <input type="text" class="input" id="taskName" placeholder="ä¾‹å¦‚ï¼šè·³ç»³" required maxlength="20">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label form-label-required">è®¡é‡å•ä½</label>
                <input type="text" class="input" id="taskUnit" placeholder="ä¾‹å¦‚ï¼š10ä¸ª/æ¬¡" required maxlength="15">
              </div>

              <div class="form-group">
                <label class="form-label form-label-required">å‚è€ƒåˆ†æ•°</label>
                <input type="number" class="input" id="taskScore" placeholder="å¯ä¸ºæ­£è´Ÿæ•°" required>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">ä»»åŠ¡ç±»å‹</label>
              <select class="select" id="taskType" required>
                <option value="positive">æ­£å‘æ¿€åŠ±</option>
                <option value="negative">è´Ÿå‘æƒ©ç½š</option>
              </select>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary btn-half" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn-primary btn-half">ä¿å­˜</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    // æäº¤ä»»åŠ¡
    function submitTask(event) {
      event.preventDefault();

      const name = document.getElementById('taskName').value.trim();
      const unit = document.getElementById('taskUnit').value.trim();
      const score = parseInt(document.getElementById('taskScore').value);
      const type = document.getElementById('taskType').value;

      const editId = event.target.dataset.editId;
      if (editId) {
        // ç¼–è¾‘æ¨¡å¼:ä¼ å…¥ taskId å’Œ updates å¯¹è±¡
        const taskId = parseInt(editId);
        const updates = {
          name,
          unit,
          score,
          type,
          enabled: true
        };
        dataManager.updateTask(taskId, updates);
        utils.showToast('ä»»åŠ¡å·²æ›´æ–°');
      } else {
        // æ–°å»ºæ¨¡å¼:ä¼ å…¥å®Œæ•´çš„ task å¯¹è±¡
        const task = {
          name,
          unit,
          score,
          type,
          enabled: true
        };
        dataManager.addTask(task);
        utils.showToast('ä»»åŠ¡å·²æ·»åŠ ');
      }

      loadTasks();
      document.querySelector('.modal-overlay').remove();
    }

    // ç¼–è¾‘ä»»åŠ¡
    function editTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <h3 class="modal-title">ç¼–è¾‘ä»»åŠ¡</h3>
          <form id="taskForm" onsubmit="submitTask(event)" data-edit-id="${task.id}">
            <div class="form-group">
              <label class="form-label form-label-required">ä»»åŠ¡åç§°</label>
              <input type="text" class="input" id="taskName" placeholder="ä¾‹å¦‚:è·³ç»³" value="${task.name}" required maxlength="20">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label form-label-required">è®¡é‡å•ä½</label>
                <input type="text" class="input" id="taskUnit" placeholder="ä¾‹å¦‚:10ä¸ª/æ¬¡" value="${task.unit}" required maxlength="15">
              </div>

              <div class="form-group">
                <label class="form-label form-label-required">å‚è€ƒåˆ†æ•°</label>
                <input type="number" class="input" id="taskScore" placeholder="å¯ä¸ºæ­£è´Ÿæ•°" value="${task.score}" required>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">ä»»åŠ¡ç±»å‹</label>
              <select class="select" id="taskType" required>
                <option value="positive" ${task.type === 'positive' ? 'selected' : ''}>æ­£å‘æ¿€åŠ±</option>
                <option value="negative" ${task.type === 'negative' ? 'selected' : ''}>è´Ÿå‘æƒ©ç½š</option>
              </select>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary btn-half" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn-primary btn-half">ä¿å­˜</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    // åˆ é™¤ä»»åŠ¡
    function deleteTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      utils.showConfirm(
        'åˆ é™¤ä»»åŠ¡',
        `ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${task.name}"å—ï¼Ÿ\n\næ³¨æ„ï¼šå·²æœ‰çš„è®°å½•ä¸ä¼šè¢«åˆ é™¤ï¼Œä½†ä»»åŠ¡å°†æ— æ³•å†ä½¿ç”¨ã€‚`,
        () => {
          dataManager.deleteTask(taskId);
          utils.showToast('ä»»åŠ¡å·²åˆ é™¤');
          loadTasks();
        }
      );
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    init();
  </script>
</body>
</html>
