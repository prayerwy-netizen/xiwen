<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç¤¼ç‰©å•†åŸ - æ›¦æ–‡ç¤¼ç‰©å…‘æ¢ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="css/common.css?v=5">
  <link rel="stylesheet" href="css/components.css?v=5">
  <style>
    .page-container {
      min-height: 100vh;
      padding: var(--spacing-lg) var(--spacing-md) 100px;
      background: var(--bg-light);
      max-width: 800px;
      margin: 0 auto;
    }

    .page-header {
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: var(--spacing-sm);
    }

    .current-score {
      font-size: 16px;
      color: var(--text-medium);
    }

    .current-score-number {
      color: var(--gold-color);
      font-weight: 700;
      font-size: 20px;
      font-family: var(--font-mono);
    }

    .gifts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      max-width: 600px;
      margin: 0 auto;
    }

    @media (min-width: 768px) {
      .gifts-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .gift-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-normal);
      overflow: hidden;
      transition: all var(--transition-normal) ease;
    }

    .gift-card:active {
      transform: translateY(-4px);
      box-shadow: var(--shadow-deep);
    }

    .gift-image {
      width: 100%;
      height: 140px;
      object-fit: cover;
      background: var(--bg-light);
    }

    .gift-info {
      padding: 12px;
    }

    .gift-name {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-dark);
      margin-bottom: var(--spacing-sm);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .gift-score {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold-color);
      font-family: var(--font-mono);
      margin-bottom: var(--spacing-md);
    }

    .gift-button {
      width: 100%;
      height: 40px;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal) ease;
    }

    .gift-button.available {
      background: var(--primary-color);
      color: var(--white);
    }

    .gift-button.insufficient {
      background: #D9D9D9;
      color: var(--text-light);
      cursor: not-allowed;
    }

    .gift-button.pending {
      background: var(--warning-color);
      color: var(--white);
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="page-header">
      <h1 class="page-title">ğŸ ç¤¼ç‰©å•†åŸ</h1>
      <div class="current-score">
        æˆ‘çš„ç§¯åˆ†ï¼š<span class="current-score-number" id="currentScore">0</span>
      </div>
    </div>

    <div class="gifts-grid" id="giftsGrid"></div>

    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-state-icon">ğŸ</div>
      <div class="empty-state-text">è¿˜æ²¡æœ‰ç¤¼ç‰©ï¼Œå¿«è®©å®¶é•¿æ·»åŠ å§ï¼</div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <div class="bottom-nav">
    <a href="index.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="#666">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
      </svg>
      <span>é¦–é¡µ</span>
    </a>
    <a href="gifts.html" class="nav-item active">
      <svg viewBox="0 0 24 24" fill="#4A90E2">
        <path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/>
      </svg>
      <span>ç¤¼ç‰©</span>
    </a>
    <a href="records.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="#666">
        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
      </svg>
      <span>è®°å½•</span>
    </a>
    <a href="parent-login.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="#666">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
      </svg>
      <span>å®¶é•¿</span>
    </a>
  </div>

  <!-- Supabase å®¢æˆ·ç«¯åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabase é…ç½® -->
  <script src="js/supabase-config.js?v=1"></script>
  <script src="js/common.js?v=5"></script>
  <script>
    const currentScore = dataManager.getTotalScore();
    document.getElementById('currentScore').textContent = currentScore;

    const gifts = dataManager.getGifts().filter(g => g.enabled);
    const requests = dataManager.getRequests();
    const pendingRequests = requests.filter(r => r.status === 'pending').map(r => r.giftId);

    if (gifts.length === 0) {
      document.getElementById('emptyState').style.display = 'block';
    } else {
      const giftsGrid = document.getElementById('giftsGrid');

      gifts.forEach(gift => {
        const isPending = pendingRequests.includes(gift.id);
        const canExchange = currentScore >= gift.score && !isPending;

        const card = document.createElement('div');
        card.className = 'gift-card';
        card.innerHTML = `
          <img src="${gift.image || 'https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=400&h=280&fit=crop'}" alt="${gift.name}" class="gift-image" onerror="this.src='https://via.placeholder.com/400x280?text=ç¤¼ç‰©å›¾ç‰‡'">
          <div class="gift-info">
            <div class="gift-name">${gift.name}</div>
            <div class="gift-score">${gift.score}åˆ†</div>
            <button class="gift-button ${isPending ? 'pending' : canExchange ? 'available' : 'insufficient'}"
                    onclick="requestExchange(${gift.id}, '${gift.name}', ${gift.score})"
                    ${!canExchange || isPending ? 'disabled' : ''}>
              ${isPending ? 'å®¡æ‰¹ä¸­...' : canExchange ? 'ç”³è¯·å…‘æ¢' : 'ç§¯åˆ†ä¸è¶³'}
            </button>
          </div>
        `;
        giftsGrid.appendChild(card);
      });
    }

    function requestExchange(giftId, giftName, score) {
      utils.showConfirm(
        'ç¡®è®¤å…‘æ¢',
        `ç¡®å®šè¦ç”¨${score}åˆ†å…‘æ¢"${giftName}"å—ï¼Ÿ`,
        () => {
          dataManager.addRequest({ giftId, giftName, score });
          utils.showToast('ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…çˆ¸çˆ¸å¦ˆå¦ˆæ‰¹å‡†å“¦~');
          setTimeout(() => location.reload(), 1500);
        }
      );
    }
  </script>
</body>
</html>
