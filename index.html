<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>æ›¦æ–‡ç¤¼ç‰©å…‘æ¢ç³»ç»Ÿ - é¦–é¡µ</title>
  <link rel="stylesheet" href="css/common.css?v=6">
  <link rel="stylesheet" href="css/components.css?v=6">
  <style>
    /* é¡µé¢å®¹å™¨ */
    .page-container {
      min-height: 100vh;
      padding-bottom: 70px;
      background: var(--bg-light);
    }

    /* å°å…ƒå®æ€»åˆ†å®¹å™¨ - ä¼˜åŒ–å°ºå¯¸ */
    .ingot-container {
      width: 90%;
      max-width: 1100px;
      margin: 12px auto;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--gold-color), var(--gold-light));
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-gold);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: transform var(--transition-normal) ease;
    }

    .ingot-container:active {
      transform: scale(0.98);
    }

    .ingot-icon {
      width: 40px;
      height: 40px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
    }

    .ingot-score {
      flex: 1;
      text-align: right;
    }

    .ingot-label {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 2px;
    }

    .ingot-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--white);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      font-family: var(--font-mono);
    }

    /* æ—¥å†å®¹å™¨ - ä¼˜åŒ–å°ºå¯¸ */
    .calendar-card {
      width: 90%;
      max-width: 1100px;
      margin: 0 auto 8px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-normal);
      padding: 18px;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .calendar-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .calendar-nav {
      display: flex;
      gap: var(--spacing-sm);
    }

    .calendar-nav button {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      background: var(--bg-light);
      color: var(--primary-color);
      font-size: 18px;
      transition: all var(--transition-normal) ease;
    }

    .calendar-nav button:hover {
      background: var(--primary-color);
      color: var(--white);
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 5px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 14px;
      color: var(--text-medium);
      padding: 5px 0;
      font-weight: 500;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day {
      min-height: 66px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-normal) ease;
      position: relative;
      padding: 7px 5px;
      font-size: 15px;
    }

    .calendar-day.empty {
      border: none;
      cursor: default;
    }

    .calendar-day.today {
      border: 2px solid var(--gold-color);
      background: #FFF9E6;
    }

    .calendar-day.has-score {
      cursor: pointer;
    }

    .calendar-day:not(.empty):not(.today):hover {
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .calendar-day-number {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 2px;
      line-height: 1;
    }

    .calendar-day-positive {
      font-size: 12px;
      color: var(--success-color);
      font-weight: 600;
      line-height: 1;
    }

    .calendar-day-negative {
      font-size: 12px;
      color: var(--error-color);
      font-weight: 600;
      line-height: 1;
    }

    /* æ—¥æœŸè¯¦æƒ…å¼¹çª— */
    .day-detail {
      max-height: 60vh;
      overflow-y: auto;
    }

    .day-detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--bg-light);
    }

    .day-detail-item:last-child {
      border-bottom: none;
    }

    .day-detail-task {
      font-size: 16px;
      color: var(--text-dark);
    }

    .day-detail-score {
      font-size: 18px;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    .day-detail-score.positive {
      color: var(--success-color);
    }

    .day-detail-score.negative {
      color: var(--error-color);
    }

    .day-detail-total {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-light);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
    }

    .day-detail-total-label {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .day-detail-total-score {
      font-size: 24px;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    /* ç•ªèŒ„é’ŸæŒ‰é’® */
    .pomodoro-trigger {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      color: var(--white);
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-normal) ease;
    }

    .pomodoro-trigger:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    }

    /* ç•ªèŒ„é’Ÿå¼¹çª— */
    .pomodoro-modal {
      padding: var(--spacing-lg);
    }

    .pomodoro-display {
      text-align: center;
      padding: var(--spacing-xl) 0;
    }

    .pomodoro-time {
      font-size: 64px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--primary-color);
      transition: color var(--transition-normal) ease;
      margin-bottom: var(--spacing-md);
      line-height: 1;
    }

    .pomodoro-time.running {
      color: var(--gold-color);
    }

    .pomodoro-time.overtime {
      color: var(--success-color);
      animation: pulse 1s ease infinite;
    }

    .pomodoro-status {
      font-size: 16px;
      color: var(--text-medium);
      margin-bottom: var(--spacing-lg);
    }

    /* æ—¶é—´è®¾ç½® */
    .time-input-group {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
      justify-content: center;
      margin-bottom: var(--spacing-lg);
    }

    .time-input-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .time-input-label {
      font-size: 14px;
      color: var(--text-medium);
      font-weight: 500;
    }

    .time-input {
      width: 90px;
      height: 56px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      text-align: center;
      font-size: 28px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--text-dark);
      transition: all var(--transition-normal) ease;
    }

    .time-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    /* å¿«æ·æ—¶é—´æŒ‰é’® */
    .quick-time-btns {
      display: flex;
      gap: 8px;
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
    }

    .quick-time-btn {
      flex: 1;
      min-width: 70px;
      height: 40px;
      background: var(--bg-light);
      border: 1px solid var(--border-color);
      color: var(--text-dark);
      font-size: 13px;
      font-weight: 500;
      border-radius: var(--radius-md);
      transition: all var(--transition-normal) ease;
    }

    .quick-time-btn:active {
      background: var(--primary-color);
      color: var(--white);
      border-color: var(--primary-color);
    }

    /* æ§åˆ¶æŒ‰é’® */
    .pomodoro-controls {
      display: flex;
      gap: var(--spacing-sm);
    }

    .pomodoro-btn {
      flex: 1;
      height: 48px;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 600;
      transition: all var(--transition-normal) ease;
    }

    .pomodoro-btn-start {
      background: var(--primary-color);
      color: var(--white);
    }

    .pomodoro-btn-start:active {
      background: #3A7BC8;
    }

    .pomodoro-btn-pause {
      background: var(--warning-color);
      color: var(--white);
    }

    .pomodoro-btn-pause:active {
      background: #E09D0D;
    }

    .pomodoro-btn-reset {
      background: var(--bg-light);
      color: var(--text-medium);
      border: 1px solid var(--border-color);
    }

    .pomodoro-btn-reset:active {
      background: var(--border-color);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* å…¨å±ä¸“æ³¨æ¨¡å¼ */
    .pomodoro-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-lg);
    }

    .pomodoro-fullscreen.show {
      display: flex;
    }

    .fullscreen-time {
      font-size: 120px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--white);
      margin-bottom: var(--spacing-lg);
      line-height: 1;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .fullscreen-time.overtime {
      color: #FF6B6B;
      animation: pulse 1s ease infinite;
    }

    .fullscreen-status {
      font-size: 24px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: var(--spacing-xl);
      font-weight: 500;
    }

    .fullscreen-exit {
      position: absolute;
      top: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: var(--white);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-normal) ease;
      backdrop-filter: blur(10px);
    }

    .fullscreen-exit:active {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(0.95);
    }

    .fullscreen-finish {
      padding: 14px 40px;
      background: rgba(255, 255, 255, 0.95);
      color: #667eea;
      font-size: 18px;
      font-weight: 600;
      border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all var(--transition-normal) ease;
    }

    .fullscreen-finish:active {
      transform: scale(0.95);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    /* çƒŸèŠ±åº†ç¥æ•ˆæœ */
    .celebration-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 10000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-lg);
    }

    .celebration-overlay.show {
      display: flex;
    }

    .celebration-content {
      text-align: center;
      animation: celebrationBounce 0.6s ease;
    }

    .celebration-icon {
      font-size: 100px;
      margin-bottom: var(--spacing-lg);
      animation: celebrationRotate 0.8s ease;
    }

    .celebration-title {
      font-size: 48px;
      font-weight: 700;
      color: var(--white);
      margin-bottom: var(--spacing-md);
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .celebration-message {
      font-size: 24px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: var(--spacing-xl);
    }

    .celebration-close {
      padding: 14px 40px;
      background: rgba(255, 255, 255, 0.95);
      color: #667eea;
      font-size: 18px;
      font-weight: 600;
      border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all var(--transition-normal) ease;
    }

    .celebration-close:active {
      transform: scale(0.95);
    }

    /* çƒŸèŠ±ç²’å­ */
    .firework {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: fireworkExplode 1s ease-out forwards;
    }

    @keyframes celebrationBounce {
      0% { transform: scale(0) translateY(100px); opacity: 0; }
      50% { transform: scale(1.1) translateY(0); }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    @keyframes celebrationRotate {
      0% { transform: rotate(0deg) scale(0); }
      50% { transform: rotate(180deg) scale(1.2); }
      100% { transform: rotate(360deg) scale(1); }
    }

    @keyframes fireworkExplode {
      0% {
        opacity: 1;
        transform: translate(0, 0);
      }
      100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty));
      }
    }

    @media (max-width: 767px) {
      .page-container {
        padding-bottom: 65px;
      }

      .ingot-container {
        width: 95%;
        margin: 8px auto;
        padding: 8px 12px;
      }

      .calendar-card {
        width: 95%;
        padding: 11px;
      }

      .ingot-icon {
        width: 32px;
        height: 32px;
        font-size: 26px;
      }

      .ingot-label {
        font-size: 11px;
      }

      .ingot-number {
        font-size: 26px;
      }

      .calendar-header {
        margin-bottom: 7px;
        padding-bottom: 7px;
      }

      .calendar-title {
        font-size: 18px;
      }

      .calendar-nav button {
        width: 31px;
        height: 31px;
        font-size: 15px;
      }

      .calendar-weekday {
        font-size: 12px;
        padding: 4px 0;
      }

      .calendar-days {
        gap: 4px;
      }

      .calendar-day {
        min-height: 55px;
        padding: 5px 3px;
        font-size: 13px;
      }

      .calendar-day-number {
        font-size: 15px;
      }

      .calendar-day-positive,
      .calendar-day-negative {
        font-size: 11px;
      }

      .fullscreen-time {
        font-size: 80px;
      }

      .fullscreen-status {
        font-size: 18px;
      }

      .celebration-icon {
        font-size: 80px;
      }

      .celebration-title {
        font-size: 36px;
      }

      .celebration-message {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- å°å…ƒå®æ€»åˆ† -->
    <div class="ingot-container" onclick="window.location.href='records.html'">
      <div class="ingot-icon">ğŸ’°</div>
      <div class="ingot-score">
        <div class="ingot-label">æˆ‘çš„ç§¯åˆ†</div>
        <div class="ingot-number" id="totalScore">0</div>
      </div>
    </div>

    <!-- æ—¥å†ä»ªè¡¨ç›˜ -->
    <div class="calendar-card">
      <div class="calendar-header">
        <h2 class="calendar-title" id="calendarTitle">2025å¹´1æœˆ</h2>
        <div class="calendar-nav">
          <button type="button" onclick="previousMonth()">â—€</button>
          <button type="button" onclick="nextMonth()">â–¶</button>
        </div>
      </div>

      <div class="calendar-weekdays">
        <div class="calendar-weekday">æ—¥</div>
        <div class="calendar-weekday">ä¸€</div>
        <div class="calendar-weekday">äºŒ</div>
        <div class="calendar-weekday">ä¸‰</div>
        <div class="calendar-weekday">å››</div>
        <div class="calendar-weekday">äº”</div>
        <div class="calendar-weekday">å…­</div>
      </div>

      <div class="calendar-days" id="calendarDays"></div>
    </div>
  </div>

  <!-- ç•ªèŒ„é’Ÿæµ®åŠ¨æŒ‰é’® -->
  <button type="button" class="pomodoro-trigger" onclick="openPomodoroModal()">ğŸ…</button>

  <!-- å…¨å±ä¸“æ³¨æ¨¡å¼ -->
  <div class="pomodoro-fullscreen" id="pomodoroFullscreen">
    <button type="button" class="fullscreen-exit" onclick="exitFullscreen()">âœ•</button>
    <div class="fullscreen-time" id="fullscreenTime">25:00</div>
    <div class="fullscreen-status" id="fullscreenStatus">ä¸“æ³¨ä¸­...</div>
    <button type="button" class="fullscreen-finish" onclick="finishPomodoro()">å®Œæˆä»»åŠ¡ ğŸ‰</button>
  </div>

  <!-- åº†ç¥é¡µé¢ -->
  <div class="celebration-overlay" id="celebrationOverlay">
    <div class="celebration-content">
      <div class="celebration-icon">ğŸ‰</div>
      <div class="celebration-title">æ­å–œæ›¦æ–‡</div>
      <div class="celebration-message">å®Œæˆä»»åŠ¡ï¼</div>
      <button type="button" class="celebration-close" onclick="closeCelebration()">å¤ªæ£’äº†ï¼</button>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <div class="bottom-nav">
    <a href="index.html" class="nav-item active">
      <svg viewBox="0 0 24 24" fill="#4A90E2">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
      </svg>
      <span>é¦–é¡µ</span>
    </a>
    <a href="gifts.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="#666">
        <path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/>
      </svg>
      <span>ç¤¼ç‰©</span>
    </a>
    <a href="records.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="#666">
        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
      </svg>
      <span>è®°å½•</span>
    </a>
    <a href="parent-login.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="#666">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
      </svg>
      <span>å®¶é•¿</span>
    </a>
  </div>

  <!-- Supabase å®¢æˆ·ç«¯åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabase é…ç½® -->
  <script src="js/supabase-config.js?v=1"></script>
  <script src="js/common.js?v=6"></script>
  <script>
    // ç•ªèŒ„æ—¶é’ŸçŠ¶æ€
    let pomodoroTimer = null;
    let pomodoroTotalSeconds = 25 * 60; // é»˜è®¤25åˆ†é’Ÿ
    let pomodoroRemainingSeconds = pomodoroTotalSeconds;
    let pomodoroIsRunning = false;
    let pomodoroIsOvertime = false;

    // åŠ è½½ä¿å­˜çš„ç•ªèŒ„é’Ÿè®¾ç½®
    function loadPomodoroSettings() {
      const saved = localStorage.getItem('pomodoro_duration');
      if (saved) {
        pomodoroTotalSeconds = parseInt(saved);
        pomodoroRemainingSeconds = pomodoroTotalSeconds;
      }
      updatePomodoroDisplay();
    }

    // ä¿å­˜ç•ªèŒ„é’Ÿè®¾ç½®
    function savePomodoroSettings(minutes, seconds) {
      pomodoroTotalSeconds = minutes * 60 + seconds;
      pomodoroRemainingSeconds = pomodoroTotalSeconds;
      localStorage.setItem('pomodoro_duration', pomodoroTotalSeconds);
      updatePomodoroDisplay();
    }

    // æ›´æ–°ç•ªèŒ„é’Ÿæ˜¾ç¤º
    function updatePomodoroDisplay() {
      // å¦‚æœå¼¹çª—æ‰“å¼€ï¼Œæ›´æ–°å¼¹çª—æ˜¾ç¤º
      updateModalDisplay();
    }

    // å¼€å§‹ç•ªèŒ„é’Ÿ
    function startPomodoro() {
      if (pomodoroIsRunning) return;

      pomodoroIsRunning = true;

      pomodoroTimer = setInterval(() => {
        pomodoroRemainingSeconds--;

        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾0ç‚¹
        if (pomodoroRemainingSeconds === 0) {
          pomodoroIsOvertime = true;
          playPomodoroAlert();
        }

        updatePomodoroDisplay();
        updateFullscreenDisplay();
      }, 1000);

      updatePomodoroDisplay();
      updateFullscreenDisplay();
    }

    // æš‚åœç•ªèŒ„é’Ÿ
    function pausePomodoro() {
      if (!pomodoroIsRunning) return;

      pomodoroIsRunning = false;
      clearInterval(pomodoroTimer);

      updatePomodoroDisplay();
      updateFullscreenDisplay();
    }

    // é‡ç½®ç•ªèŒ„é’Ÿ
    function resetPomodoro() {
      pausePomodoro();
      pomodoroRemainingSeconds = pomodoroTotalSeconds;
      pomodoroIsOvertime = false;

      updatePomodoroDisplay();
      updateFullscreenDisplay();
    }

    // æ’­æ”¾æç¤ºéŸ³ï¼ˆä½¿ç”¨Web Audio APIï¼‰
    function playPomodoroAlert() {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.5);
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    // æ‰“å¼€ç•ªèŒ„é’Ÿå¼¹çª—
    function openPomodoroModal() {
      const currentMinutes = Math.floor(pomodoroTotalSeconds / 60);
      const currentSeconds = pomodoroTotalSeconds % 60;

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.id = 'pomodoroModalOverlay';
      overlay.innerHTML = `
        <div class="modal pomodoro-modal">
          <h3 class="modal-title">ğŸ… ç•ªèŒ„æ—¶é’Ÿ</h3>

          <!-- æ—¶é—´æ˜¾ç¤º -->
          <div class="pomodoro-display">
            <div class="pomodoro-time" id="pomodoroTimeDisplay">25:00</div>
            <div class="pomodoro-status" id="pomodoroStatusDisplay">å‡†å¤‡å¼€å§‹</div>
          </div>

          <!-- æ—¶é—´è®¾ç½® -->
          <div class="time-input-group">
            <div class="time-input-wrapper">
              <label class="time-input-label">åˆ†é’Ÿ</label>
              <input type="number" class="time-input" id="pomodoroMinutes"
                     value="${currentMinutes}" min="0" max="99"
                     onchange="updatePomodoroPreview()" ${pomodoroIsRunning ? 'disabled' : ''}>
            </div>
            <div style="font-size: 32px; font-weight: 700; color: var(--text-medium);">:</div>
            <div class="time-input-wrapper">
              <label class="time-input-label">ç§’é’Ÿ</label>
              <input type="number" class="time-input" id="pomodoroSeconds"
                     value="${currentSeconds}" min="0" max="59"
                     onchange="updatePomodoroPreview()" ${pomodoroIsRunning ? 'disabled' : ''}>
            </div>
          </div>

          <!-- å¿«æ·æ—¶é—´ -->
          <div class="quick-time-btns">
            <button class="quick-time-btn" onclick="setQuickTime(15, 0)" ${pomodoroIsRunning ? 'disabled' : ''}>15åˆ†é’Ÿ</button>
            <button class="quick-time-btn" onclick="setQuickTime(25, 0)" ${pomodoroIsRunning ? 'disabled' : ''}>25åˆ†é’Ÿ</button>
            <button class="quick-time-btn" onclick="setQuickTime(30, 0)" ${pomodoroIsRunning ? 'disabled' : ''}>30åˆ†é’Ÿ</button>
            <button class="quick-time-btn" onclick="setQuickTime(45, 0)" ${pomodoroIsRunning ? 'disabled' : ''}>45åˆ†é’Ÿ</button>
          </div>

          <!-- æ§åˆ¶æŒ‰é’® -->
          <div class="pomodoro-controls">
            <button type="button" class="pomodoro-btn pomodoro-btn-start" id="modalPomodoroStart"
                    onclick="startPomodoroFromModal()" ${pomodoroIsRunning ? 'style="display:none;"' : ''}>å¼€å§‹</button>
            <button type="button" class="pomodoro-btn pomodoro-btn-pause" id="modalPomodoroPause"
                    onclick="pausePomodoroFromModal()" ${!pomodoroIsRunning ? 'style="display:none;"' : ''}>æš‚åœ</button>
            <button type="button" class="pomodoro-btn pomodoro-btn-reset" onclick="resetPomodoroFromModal()">é‡ç½®</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      // æ›´æ–°å¼¹çª—ä¸­çš„æ˜¾ç¤º
      updateModalDisplay();

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          closePomodoroModal();
        }
      };
    }

    // å…³é—­ç•ªèŒ„é’Ÿå¼¹çª—
    function closePomodoroModal() {
      const overlay = document.getElementById('pomodoroModalOverlay');
      if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => overlay.remove(), 200);
      }
    }

    // ä»å¼¹çª—å¼€å§‹ç•ªèŒ„é’Ÿ
    function startPomodoroFromModal() {
      // åº”ç”¨è®¾ç½®
      const minutes = parseInt(document.getElementById('pomodoroMinutes').value) || 0;
      const seconds = parseInt(document.getElementById('pomodoroSeconds').value) || 0;

      if (minutes === 0 && seconds === 0) {
        utils.showToast('æ—¶é—´ä¸èƒ½ä¸º0', 'warning');
        return;
      }

      if (seconds >= 60) {
        utils.showToast('ç§’æ•°ä¸èƒ½è¶…è¿‡59', 'warning');
        return;
      }

      savePomodoroSettings(minutes, seconds);

      // å¼€å§‹è®¡æ—¶
      startPomodoro();

      // å…³é—­å¼¹çª—
      closePomodoroModal();

      // è¿›å…¥å…¨å±ä¸“æ³¨æ¨¡å¼
      enterFullscreen();
    }

    // ä»å¼¹çª—æš‚åœç•ªèŒ„é’Ÿ
    function pausePomodoroFromModal() {
      pausePomodoro();
      document.getElementById('modalPomodoroStart').style.display = 'block';
      document.getElementById('modalPomodoroPause').style.display = 'none';
    }

    // ä»å¼¹çª—é‡ç½®ç•ªèŒ„é’Ÿ
    function resetPomodoroFromModal() {
      resetPomodoro();

      // å¯ç”¨æ—¶é—´è¾“å…¥
      document.getElementById('pomodoroMinutes').disabled = false;
      document.getElementById('pomodoroSeconds').disabled = false;
      document.querySelectorAll('.quick-time-btn').forEach(btn => btn.disabled = false);

      // æ›´æ–°æŒ‰é’®
      document.getElementById('modalPomodoroStart').style.display = 'block';
      document.getElementById('modalPomodoroPause').style.display = 'none';

      updateModalDisplay();
    }

    // æ›´æ–°å¼¹çª—ä¸­çš„æ˜¾ç¤º
    function updateModalDisplay() {
      const timeElement = document.getElementById('pomodoroTimeDisplay');
      const statusElement = document.getElementById('pomodoroStatusDisplay');

      if (!timeElement || !statusElement) return;

      const absSeconds = Math.abs(pomodoroRemainingSeconds);
      const minutes = Math.floor(absSeconds / 60);
      const seconds = absSeconds % 60;
      const sign = pomodoroRemainingSeconds < 0 ? '-' : '';

      timeElement.textContent = `${sign}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

      // æ›´æ–°çŠ¶æ€æ ·å¼
      timeElement.classList.remove('running', 'overtime');
      if (pomodoroIsOvertime) {
        timeElement.classList.add('overtime');
        statusElement.textContent = 'å·²è¶…æ—¶ï¼';
      } else if (pomodoroIsRunning) {
        timeElement.classList.add('running');
        statusElement.textContent = 'ä¸“æ³¨ä¸­...';
      } else if (pomodoroRemainingSeconds === pomodoroTotalSeconds) {
        statusElement.textContent = 'å‡†å¤‡å¼€å§‹';
      } else {
        statusElement.textContent = 'å·²æš‚åœ';
      }
    }

    // æ›´æ–°é¢„è§ˆæ˜¾ç¤º
    function updatePomodoroPreview() {
      const minutes = parseInt(document.getElementById('pomodoroMinutes').value) || 0;
      const seconds = parseInt(document.getElementById('pomodoroSeconds').value) || 0;

      const timeElement = document.getElementById('pomodoroTimeDisplay');
      if (timeElement && !pomodoroIsRunning) {
        timeElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
    }

    // å¿«æ·è®¾ç½®æ—¶é—´
    function setQuickTime(minutes, seconds) {
      document.getElementById('pomodoroMinutes').value = minutes;
      document.getElementById('pomodoroSeconds').value = seconds;
      updatePomodoroPreview();
    }

    // è¿›å…¥å…¨å±ä¸“æ³¨æ¨¡å¼
    function enterFullscreen() {
      const fullscreen = document.getElementById('pomodoroFullscreen');
      fullscreen.classList.add('show');
      updateFullscreenDisplay();
    }

    // é€€å‡ºå…¨å±ä¸“æ³¨æ¨¡å¼
    function exitFullscreen() {
      const fullscreen = document.getElementById('pomodoroFullscreen');
      fullscreen.classList.remove('show');

      // æš‚åœè®¡æ—¶
      if (pomodoroIsRunning) {
        pausePomodoro();
      }

      // ç¡®ä¿ä¸è§¦å‘æµè§ˆå™¨åŸç”Ÿå…¨å±API
      if (document.fullscreenElement || document.webkitFullscreenElement ||
          document.mozFullScreenElement || document.msFullscreenElement) {
        try {
          if (document.exitFullscreen) {
            document.exitFullscreen().catch(() => {});
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        } catch (e) {
          // å¿½ç•¥å…¨å±APIé”™è¯¯
        }
      }
    }

    // æ›´æ–°å…¨å±æ˜¾ç¤º
    function updateFullscreenDisplay() {
      const timeElement = document.getElementById('fullscreenTime');
      const statusElement = document.getElementById('fullscreenStatus');

      if (!timeElement || !statusElement) return;

      const absSeconds = Math.abs(pomodoroRemainingSeconds);
      const minutes = Math.floor(absSeconds / 60);
      const seconds = absSeconds % 60;
      const sign = pomodoroRemainingSeconds < 0 ? '-' : '';

      timeElement.textContent = `${sign}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

      // æ›´æ–°çŠ¶æ€æ ·å¼
      timeElement.classList.remove('overtime');
      if (pomodoroIsOvertime) {
        timeElement.classList.add('overtime');
        statusElement.textContent = 'å·²è¶…æ—¶ï¼';
      } else if (pomodoroIsRunning) {
        statusElement.textContent = 'ä¸“æ³¨ä¸­...';
      } else {
        statusElement.textContent = 'å·²æš‚åœ';
      }
    }

    // å®Œæˆç•ªèŒ„é’Ÿä»»åŠ¡
    function finishPomodoro() {
      // æš‚åœè®¡æ—¶
      if (pomodoroIsRunning) {
        pausePomodoro();
      }

      // é€€å‡ºå…¨å±
      const fullscreen = document.getElementById('pomodoroFullscreen');
      fullscreen.classList.remove('show');

      // æ˜¾ç¤ºåº†ç¥é¡µé¢
      showCelebration();
    }

    // æ˜¾ç¤ºåº†ç¥æ•ˆæœ
    function showCelebration() {
      const overlay = document.getElementById('celebrationOverlay');
      overlay.classList.add('show');

      // åˆ›å»ºçƒŸèŠ±æ•ˆæœ
      createFireworks();

      // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
      playCelebrationSound();
    }

    // å…³é—­åº†ç¥é¡µé¢
    function closeCelebration() {
      const overlay = document.getElementById('celebrationOverlay');
      overlay.classList.remove('show');

      // æ¸…é™¤æ‰€æœ‰çƒŸèŠ±
      document.querySelectorAll('.firework').forEach(fw => fw.remove());

      // é‡ç½®ç•ªèŒ„é’Ÿ
      resetPomodoro();
    }

    // åˆ›å»ºçƒŸèŠ±æ•ˆæœ
    function createFireworks() {
      const overlay = document.getElementById('celebrationOverlay');
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

      // åˆ›å»ºå¤šç»„çƒŸèŠ±
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          const x = Math.random() * window.innerWidth;
          const y = Math.random() * (window.innerHeight * 0.6);

          // æ¯ç»„çƒŸèŠ±30ä¸ªç²’å­
          for (let j = 0; j < 30; j++) {
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = x + 'px';
            firework.style.top = y + 'px';
            firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

            // éšæœºæ–¹å‘
            const angle = (Math.PI * 2 * j) / 30;
            const velocity = 100 + Math.random() * 100;
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;

            firework.style.setProperty('--tx', tx + 'px');
            firework.style.setProperty('--ty', ty + 'px');

            overlay.appendChild(firework);

            // 1ç§’åç§»é™¤
            setTimeout(() => firework.remove(), 1000);
          }
        }, i * 300);
      }
    }

    // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
    function playCelebrationSound() {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // æ’­æ”¾3ä¸ªéŸ³ç¬¦ç»„æˆçš„æ¬¢å¿«æ—‹å¾‹
        const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
        notes.forEach((freq, index) => {
          setTimeout(() => {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.frequency.value = freq;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
          }, index * 150);
        });
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    // å½“å‰æ˜¾ç¤ºçš„å¹´æœˆ
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    // åˆå§‹åŒ–é¡µé¢
    async function init() {
      loadPomodoroSettings(); // åŠ è½½ç•ªèŒ„é’Ÿè®¾ç½®

      // ç­‰å¾…äº‘åŒæ­¥å®Œæˆåå†æ¸²æŸ“
      if (window.supabaseSync && window.supabaseSync.enabled) {
        try {
          await window.supabaseSync.init();
          console.log('âœ… äº‘åŒæ­¥å®Œæˆ,å¼€å§‹æ¸²æŸ“é¡µé¢');

          // å¯ç”¨å®æ—¶ç›‘å¬ - å½“å…¶ä»–ç»ˆç«¯ä¿®æ”¹æ•°æ®æ—¶è‡ªåŠ¨æ›´æ–°é¡µé¢
          window.supabaseSync.enableRealtime((tableName) => {
            console.log(`ğŸ”„ ${tableName} æ•°æ®å·²æ›´æ–°,åˆ·æ–°é¡µé¢æ˜¾ç¤º`);
            updateTotalScore();
            renderCalendar();
          });
        } catch (error) {
          console.error('âŒ äº‘åŒæ­¥å¤±è´¥,ä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
        }
      }

      updateTotalScore();
      renderCalendar();
    }

    // æ›´æ–°æ€»ç§¯åˆ†
    function updateTotalScore() {
      const totalScore = dataManager.getTotalScore();
      document.getElementById('totalScore').textContent = totalScore;

      // æ·»åŠ è„‰å†²åŠ¨ç”»
      const scoreElement = document.getElementById('totalScore');
      scoreElement.style.animation = 'none';
      setTimeout(() => {
        scoreElement.style.animation = 'pulse 0.5s ease';
      }, 10);
    }

    // æ¸²æŸ“æ—¥å†
    function renderCalendar() {
      const title = document.getElementById('calendarTitle');
      title.textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;

      const daysContainer = document.getElementById('calendarDays');
      daysContainer.innerHTML = '';

      // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const firstDayWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      // è·å–å½“æœˆç§¯åˆ†æ•°æ®
      const dailyScores = dataManager.getDailyScores(currentMonth, currentYear);

      // å¡«å……ç©ºç™½å¤©æ•°
      for (let i = 0; i < firstDayWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        daysContainer.appendChild(emptyDay);
      }

      // å¡«å……æ—¥æœŸ
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';

        const isToday = day === today.getDate() &&
                       currentMonth === today.getMonth() &&
                       currentYear === today.getFullYear();

        if (isToday) {
          dayElement.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);

        // æ˜¾ç¤ºç§¯åˆ†
        if (dailyScores[day]) {
          dayElement.classList.add('has-score');
          if (dailyScores[day].positive > 0) {
            const positive = document.createElement('div');
            positive.className = 'calendar-day-positive';
            positive.textContent = '+' + dailyScores[day].positive;
            dayElement.appendChild(positive);
          }
          if (dailyScores[day].negative < 0) {
            const negative = document.createElement('div');
            negative.className = 'calendar-day-negative';
            negative.textContent = dailyScores[day].negative;
            dayElement.appendChild(negative);
          }

          dayElement.onclick = () => showDayDetail(day);
        }

        daysContainer.appendChild(dayElement);
      }
    }

    // æ˜¾ç¤ºæ—¥æœŸè¯¦æƒ…
    function showDayDetail(day) {
      const date = new Date(currentYear, currentMonth, day);
      const records = dataManager.getRecordsByDate(date);

      if (records.length === 0) return;

      let detailHTML = '<div class="day-detail">';
      let totalScore = 0;

      records.forEach(record => {
        totalScore += record.score;
        const scoreClass = record.score > 0 ? 'positive' : 'negative';
        const scoreText = record.score > 0 ? '+' + record.score : record.score;

        detailHTML += `
          <div class="day-detail-item">
            <div class="day-detail-task">${record.taskName}</div>
            <div class="day-detail-score ${scoreClass}">${scoreText}</div>
          </div>
        `;
      });

      const totalClass = totalScore > 0 ? 'positive' : 'negative';
      const totalText = totalScore > 0 ? '+' + totalScore : totalScore;

      detailHTML += `
        <div class="day-detail-total">
          <div class="day-detail-total-label">å½“æ—¥æ€»è®¡</div>
          <div class="day-detail-total-score ${totalClass}">${totalText}</div>
        </div>
      </div>`;

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <h3 class="modal-title">${currentMonth + 1}æœˆ${day}æ—¥</h3>
          ${detailHTML}
          <div class="modal-actions">
            <button class="btn-primary btn-full" onclick="this.closest('.modal-overlay').remove()">å…³é—­</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    // ä¸Šä¸€ä¸ªæœˆ
    function previousMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    }

    // ä¸‹ä¸€ä¸ªæœˆ
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }

    // å…¨å±€Promise rejectionå¤„ç†å™¨ï¼ˆé˜²æ­¢å…¨å±APIé”™è¯¯ï¼‰
    window.addEventListener('unhandledrejection', function(event) {
      // å¿½ç•¥å…¨å±APIç›¸å…³çš„é”™è¯¯
      if (event.reason && event.reason.message &&
          (event.reason.message.includes('exitFullscreen') ||
           event.reason.message.includes('fullscreen'))) {
        event.preventDefault();
        console.log('å¿½ç•¥å…¨å±APIé”™è¯¯:', event.reason.message);
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    init();
  </script>
</body>
</html>
