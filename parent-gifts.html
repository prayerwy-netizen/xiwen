<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¼ç‰©ç®¡ç† - æ›¦æ–‡ç¤¼ç‰©å…‘æ¢ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="css/common.css?v=5">
  <link rel="stylesheet" href="css/components.css?v=5">
  <style>
    body {
      background: var(--bg-light);
      padding-bottom: 80px;
    }

    .page-content {
      padding: var(--spacing-lg) var(--spacing-md);
      max-width: 1000px;
      margin: 0 auto;
    }

    .action-bar {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .gifts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-lg);
    }

    .gift-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-normal);
      overflow: hidden;
      transition: all var(--transition-normal) ease;
    }

    .gift-card.disabled {
      opacity: 0.5;
    }

    .gift-image-container {
      position: relative;
      width: 100%;
      height: 180px;
      background: var(--bg-light);
      overflow: hidden;
    }

    .gift-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gift-status-badge {
      position: absolute;
      top: var(--spacing-sm);
      right: var(--spacing-sm);
      padding: 4px 12px;
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.6);
      color: var(--white);
    }

    .gift-status-badge.enabled {
      background: var(--success-color);
    }

    .gift-info {
      padding: var(--spacing-md);
    }

    .gift-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: var(--spacing-sm);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .gift-score-display {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold-color);
      font-family: var(--font-mono);
      margin-bottom: var(--spacing-md);
    }

    .gift-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .gift-action-btn {
      flex: 1;
      height: 40px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal) ease;
    }

    .gift-action-btn.toggle {
      background: var(--bg-light);
      color: var(--text-dark);
    }

    .gift-action-btn.edit {
      background: var(--primary-color);
      color: var(--white);
    }

    .gift-action-btn.delete {
      background: var(--error-color);
      color: var(--white);
    }

    .image-upload-area {
      width: 100%;
      height: 200px;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-normal) ease;
      position: relative;
      overflow: hidden;
      background: var(--bg-light);
    }

    .image-upload-area:hover {
      border-color: var(--primary-color);
      background: #F0F7FF;
    }

    .image-upload-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .image-upload-preview.show {
      display: block;
    }

    .image-upload-placeholder {
      text-align: center;
      color: var(--text-light);
    }

    .image-upload-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-sm);
    }

    .image-url-input-group {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    @media (max-width: 767px) {
      .gifts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="top-nav">
    <div class="top-nav-left">
      <button onclick="window.location.href='parent-record.html'">â—€ è¿”å›</button>
    </div>
    <div class="top-nav-title">ç¤¼ç‰©ç®¡ç†</div>
    <div class="top-nav-right">
      <button onclick="utils.exitParentMode()">é€€å‡º</button>
    </div>
  </div>

  <div class="page-content">
    <div class="action-bar">
      <button class="btn-primary" style="flex: 1;" onclick="showAddGiftModal()">â• æ–°å¢ç¤¼ç‰©</button>
    </div>

    <div class="gifts-grid" id="giftsGrid"></div>

    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-state-icon">ğŸ</div>
      <div class="empty-state-text">è¿˜æ²¡æœ‰ç¤¼ç‰©ï¼Œå¿«æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</div>
    </div>
  </div>

  <!-- åº•éƒ¨èœå• -->
  <div class="parent-menu">
    <button class="menu-btn" onclick="window.location.href='parent-record.html'">å¿«é€Ÿè®°è´¦</button>
    <button class="menu-btn" onclick="window.location.href='parent-tasks.html'">ä»»åŠ¡ç®¡ç†</button>
    <button class="menu-btn" onclick="window.location.href='parent-approval.html'">å…‘æ¢å®¡æ‰¹</button>
    <button class="menu-btn" onclick="window.location.href='parent-settings.html'">è®¾ç½®</button>
  </div>

  <!-- Supabase å®¢æˆ·ç«¯åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabase é…ç½® -->
  <script src="js/supabase-config.js?v=1"></script>
  <script src="js/common.js?v=5"></script>
  <script>
    utils.requireParentMode();

    let gifts = [];
    let currentImageUrl = '';

    // åˆå§‹åŒ–
    function init() {
      loadGifts();
    }

    // åŠ è½½ç¤¼ç‰©åˆ—è¡¨
    function loadGifts() {
      gifts = dataManager.getGifts();
      renderGifts();
    }

    // æ¸²æŸ“ç¤¼ç‰©åˆ—è¡¨
    function renderGifts() {
      const giftsGrid = document.getElementById('giftsGrid');
      const emptyState = document.getElementById('emptyState');

      if (gifts.length === 0) {
        giftsGrid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      giftsGrid.innerHTML = '';

      gifts.forEach(gift => {
        const card = document.createElement('div');
        card.className = `gift-card ${gift.enabled ? '' : 'disabled'}`;

        const defaultImage = 'https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=400&h=300&fit=crop';

        card.innerHTML = `
          <div class="gift-image-container">
            <img src="${gift.image || defaultImage}"
                 alt="${gift.name}"
                 class="gift-image"
                 onerror="this.src='https://via.placeholder.com/400x300?text=ç¤¼ç‰©å›¾ç‰‡'">
            <div class="gift-status-badge ${gift.enabled ? 'enabled' : ''}">${gift.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</div>
          </div>
          <div class="gift-info">
            <div class="gift-name">${gift.name}</div>
            <div class="gift-score-display">${gift.score}åˆ†</div>
            <div class="gift-actions">
              <button class="gift-action-btn toggle" onclick="toggleGift(${gift.id})">
                ${gift.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
              </button>
              <button class="gift-action-btn edit" onclick="editGift(${gift.id})">âœï¸ ç¼–è¾‘</button>
              <button class="gift-action-btn delete" onclick="deleteGift(${gift.id})">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;

        giftsGrid.appendChild(card);
      });
    }

    // åˆ‡æ¢ç¤¼ç‰©å¯ç”¨çŠ¶æ€
    function toggleGift(giftId) {
      const gift = gifts.find(g => g.id === giftId);
      if (!gift) return;

      gift.enabled = !gift.enabled;
      dataManager.updateGift(gift);
      loadGifts();
      utils.showToast(gift.enabled ? 'ç¤¼ç‰©å·²å¯ç”¨' : 'ç¤¼ç‰©å·²ç¦ç”¨');
    }

    // æ˜¾ç¤ºæ–°å¢ç¤¼ç‰©å¼¹çª—
    function showAddGiftModal() {
      currentImageUrl = '';

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width: 500px;">
          <h3 class="modal-title">æ–°å¢ç¤¼ç‰©</h3>
          <form id="giftForm" onsubmit="submitGift(event)">
            <div class="form-group">
              <label class="form-label form-label-required">ç¤¼ç‰©å›¾ç‰‡</label>
              <div class="image-upload-area" onclick="document.getElementById('imageUrlInput').focus()">
                <img id="imagePreview" class="image-upload-preview" alt="é¢„è§ˆ">
                <div class="image-upload-placeholder" id="uploadPlaceholder">
                  <div class="image-upload-icon">ğŸ–¼ï¸</div>
                  <div>è¾“å…¥å›¾ç‰‡ç½‘å€</div>
                </div>
              </div>
              <div class="image-url-input-group">
                <input type="url" class="input" id="imageUrlInput"
                       placeholder="ç²˜è´´å›¾ç‰‡ç½‘å€ï¼ˆhttps://...ï¼‰"
                       oninput="previewImage(this.value)">
              </div>
              <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">
                ğŸ’¡ æç¤ºï¼šå¯ä»unsplash.comã€pexels.comç­‰ç½‘ç«™å¤åˆ¶å›¾ç‰‡é“¾æ¥
              </div>
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">ç¤¼ç‰©åç§°</label>
              <input type="text" class="input" id="giftName" placeholder="ä¾‹å¦‚ï¼šç”µè¯æ‰‹è¡¨" required maxlength="30">
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">æ‰€éœ€ç§¯åˆ†</label>
              <input type="number" class="input" id="giftScore" placeholder="éœ€è¦å¤šå°‘ç§¯åˆ†å…‘æ¢" required min="1">
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary btn-half" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn-primary btn-half">ä¿å­˜</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    // é¢„è§ˆå›¾ç‰‡
    function previewImage(url) {
      currentImageUrl = url;
      const preview = document.getElementById('imagePreview');
      const placeholder = document.getElementById('uploadPlaceholder');

      if (url && url.startsWith('http')) {
        preview.src = url;
        preview.classList.add('show');
        placeholder.style.display = 'none';
      } else {
        preview.classList.remove('show');
        placeholder.style.display = 'block';
      }
    }

    // æäº¤ç¤¼ç‰©
    function submitGift(event) {
      event.preventDefault();

      const name = document.getElementById('giftName').value.trim();
      const score = parseInt(document.getElementById('giftScore').value);
      const image = currentImageUrl || '';

      if (!name) {
        utils.showToast('è¯·è¾“å…¥ç¤¼ç‰©åç§°', 'error');
        return;
      }

      if (score < 1) {
        utils.showToast('ç§¯åˆ†å¿…é¡»å¤§äº0', 'error');
        return;
      }

      const gift = {
        name,
        image,
        score,
        enabled: true
      };

      const editId = event.target.dataset.editId;
      if (editId) {
        gift.id = parseInt(editId);
        dataManager.updateGift(gift);
        utils.showToast('ç¤¼ç‰©å·²æ›´æ–°');
      } else {
        dataManager.addGift(gift);
        utils.showToast('ç¤¼ç‰©å·²æ·»åŠ ');
      }

      loadGifts();
      document.querySelector('.modal-overlay').remove();
    }

    // ç¼–è¾‘ç¤¼ç‰©
    function editGift(giftId) {
      const gift = gifts.find(g => g.id === giftId);
      if (!gift) return;

      currentImageUrl = gift.image || '';

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width: 500px;">
          <h3 class="modal-title">ç¼–è¾‘ç¤¼ç‰©</h3>
          <form id="giftForm" onsubmit="submitGift(event)" data-edit-id="${gift.id}">
            <div class="form-group">
              <label class="form-label form-label-required">ç¤¼ç‰©å›¾ç‰‡</label>
              <div class="image-upload-area" onclick="document.getElementById('imageUrlInput').focus()">
                <img id="imagePreview" class="image-upload-preview ${currentImageUrl ? 'show' : ''}"
                     src="${currentImageUrl}" alt="é¢„è§ˆ">
                <div class="image-upload-placeholder" id="uploadPlaceholder"
                     style="${currentImageUrl ? 'display: none;' : ''}">
                  <div class="image-upload-icon">ğŸ–¼ï¸</div>
                  <div>è¾“å…¥å›¾ç‰‡ç½‘å€</div>
                </div>
              </div>
              <div class="image-url-input-group">
                <input type="url" class="input" id="imageUrlInput"
                       placeholder="ç²˜è´´å›¾ç‰‡ç½‘å€ï¼ˆhttps://...ï¼‰"
                       value="${currentImageUrl}"
                       oninput="previewImage(this.value)">
              </div>
              <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">
                ğŸ’¡ æç¤ºï¼šå¯ä»unsplash.comã€pexels.comç­‰ç½‘ç«™å¤åˆ¶å›¾ç‰‡é“¾æ¥
              </div>
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">ç¤¼ç‰©åç§°</label>
              <input type="text" class="input" id="giftName" placeholder="ä¾‹å¦‚ï¼šç”µè¯æ‰‹è¡¨"
                     value="${gift.name}" required maxlength="30">
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">æ‰€éœ€ç§¯åˆ†</label>
              <input type="number" class="input" id="giftScore" placeholder="éœ€è¦å¤šå°‘ç§¯åˆ†å…‘æ¢"
                     value="${gift.score}" required min="1">
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary btn-half" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn-primary btn-half">ä¿å­˜</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    // åˆ é™¤ç¤¼ç‰©
    function deleteGift(giftId) {
      const gift = gifts.find(g => g.id === giftId);
      if (!gift) return;

      utils.showConfirm(
        'åˆ é™¤ç¤¼ç‰©',
        `ç¡®å®šè¦åˆ é™¤ç¤¼ç‰©"${gift.name}"å—ï¼Ÿ\n\næ³¨æ„ï¼šç›¸å…³çš„å…‘æ¢ç”³è¯·ä¹Ÿå°†è¢«åˆ é™¤ã€‚`,
        () => {
          dataManager.deleteGift(giftId);
          utils.showToast('ç¤¼ç‰©å·²åˆ é™¤');
          loadGifts();
        }
      );
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    init();
  </script>
</body>
</html>
