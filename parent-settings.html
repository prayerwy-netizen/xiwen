<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¾ç½® - æ›¦æ–‡ç¤¼ç‰©å…‘æ¢ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="css/common.css?v=5">
  <link rel="stylesheet" href="css/components.css?v=5">
  <style>
    body {
      background: var(--bg-light);
      padding-bottom: 80px;
    }

    .page-content {
      padding: var(--spacing-lg) var(--spacing-md);
      max-width: 600px;
      margin: 0 auto;
    }

    .settings-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-normal);
      margin-bottom: var(--spacing-lg);
      overflow: hidden;
    }

    .section-title {
      padding: var(--spacing-md);
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      border-bottom: 1px solid var(--border-color);
    }

    .settings-list {
      display: flex;
      flex-direction: column;
    }

    .setting-item {
      padding: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background var(--transition-normal) ease;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-item:active {
      background: var(--bg-light);
    }

    .setting-info {
      flex: 1;
    }

    .setting-label {
      font-size: 16px;
      color: var(--text-dark);
      margin-bottom: 4px;
    }

    .setting-desc {
      font-size: 14px;
      color: var(--text-light);
    }

    .setting-arrow {
      font-size: 18px;
      color: var(--text-light);
    }

    .danger-section .setting-item {
      color: var(--error-color);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      padding: var(--spacing-md);
    }

    .stat-card {
      text-align: center;
      padding: var(--spacing-md);
      background: var(--bg-light);
      border-radius: var(--radius-md);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
      font-family: var(--font-mono);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-medium);
    }

    .pin-input-container {
      display: flex;
      justify-content: center;
      gap: var(--spacing-md);
      margin: var(--spacing-lg) 0;
    }

    .pin-input-dot {
      width: 50px;
      height: 50px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 24px;
      text-align: center;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    .pin-input-dot:focus {
      border-color: var(--primary-color);
      outline: none;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="top-nav">
    <div class="top-nav-left">
      <button onclick="window.location.href='parent-record.html'">â—€ è¿”å›</button>
    </div>
    <div class="top-nav-title">è®¾ç½®</div>
    <div class="top-nav-right">
      <button onclick="utils.exitParentMode()">é€€å‡º</button>
    </div>
  </div>

  <div class="page-content">
    <!-- æ•°æ®ç»Ÿè®¡ -->
    <div class="settings-section">
      <div class="section-title">æ•°æ®ç»Ÿè®¡</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalRecords">0</div>
          <div class="stat-label">æ€»è®°å½•æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalTasks">0</div>
          <div class="stat-label">ä»»åŠ¡æ•°é‡</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalGifts">0</div>
          <div class="stat-label">ç¤¼ç‰©æ•°é‡</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalScore">0</div>
          <div class="stat-label">å½“å‰ç§¯åˆ†</div>
        </div>
      </div>
    </div>

    <!-- ç§¯åˆ†ç®¡ç† -->
    <div class="settings-section">
      <div class="section-title">ç§¯åˆ†ç®¡ç†</div>
      <div class="settings-list">
        <div class="setting-item" onclick="showInitScoreModal()">
          <div class="setting-info">
            <div class="setting-label">ç§¯åˆ†åˆå§‹åŒ–</div>
            <div class="setting-desc">å°†çº¸è´¨è®°å½•çš„ç§¯åˆ†å½•å…¥ç³»ç»Ÿ</div>
          </div>
          <div class="setting-arrow">â€º</div>
        </div>
      </div>
    </div>

    <!-- å®‰å…¨è®¾ç½® -->
    <div class="settings-section">
      <div class="section-title">å®‰å…¨è®¾ç½®</div>
      <div class="settings-list">
        <div class="setting-item" onclick="showChangePinModal()">
          <div class="setting-info">
            <div class="setting-label">ä¿®æ”¹PINç </div>
            <div class="setting-desc">ä¿®æ”¹å®¶é•¿éªŒè¯PINç </div>
          </div>
          <div class="setting-arrow">â€º</div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®ç®¡ç† -->
    <div class="settings-section">
      <div class="section-title">æ•°æ®ç®¡ç†</div>
      <div class="settings-list">
        <div class="setting-item" id="cloudSyncStatus" onclick="manualCloudSync()">
          <div class="setting-info">
            <div class="setting-label">äº‘ç«¯åŒæ­¥</div>
            <div class="setting-desc" id="cloudSyncDesc">æ£€æŸ¥äº‘åŒæ­¥çŠ¶æ€...</div>
          </div>
          <div class="setting-arrow">â†»</div>
        </div>
        <div class="setting-item" id="migrateToCloud" onclick="migrateLocalToCloud()" style="display:none;">
          <div class="setting-info">
            <div class="setting-label">è¿ç§»æ•°æ®åˆ°äº‘ç«¯</div>
            <div class="setting-desc">å°†æœ¬åœ°æ•°æ®ä¸Šä¼ åˆ°Supabaseäº‘ç«¯</div>
          </div>
          <div class="setting-arrow">â˜</div>
        </div>
        <div class="setting-item" onclick="exportData()">
          <div class="setting-info">
            <div class="setting-label">å¯¼å‡ºæ•°æ®</div>
            <div class="setting-desc">å¤‡ä»½æ‰€æœ‰æ•°æ®åˆ°JSONæ–‡ä»¶</div>
          </div>
          <div class="setting-arrow">â€º</div>
        </div>
        <div class="setting-item" onclick="document.getElementById('importFile').click()">
          <div class="setting-info">
            <div class="setting-label">å¯¼å…¥æ•°æ®</div>
            <div class="setting-desc">ä»JSONæ–‡ä»¶è¿˜åŸæ•°æ®</div>
          </div>
          <div class="setting-arrow">â€º</div>
        </div>
        <div class="setting-item" onclick="showDeleteRecordsModal()">
          <div class="setting-info">
            <div class="setting-label">åˆ é™¤è®°å½•</div>
            <div class="setting-desc">æŒ‰æ—¥æœŸæŸ¥çœ‹å’Œåˆ é™¤ç§¯åˆ†è®°å½•</div>
          </div>
          <div class="setting-arrow">â€º</div>
        </div>
      </div>
    </div>

    <!-- å±é™©æ“ä½œ -->
    <div class="settings-section danger-section">
      <div class="section-title" style="color: var(--error-color);">å±é™©æ“ä½œ</div>
      <div class="settings-list">
        <div class="setting-item" onclick="clearAllData()">
          <div class="setting-info">
            <div class="setting-label">æ¸…ç©ºæ‰€æœ‰æ•°æ®</div>
            <div class="setting-desc">åˆ é™¤æ‰€æœ‰è®°å½•ã€ä»»åŠ¡å’Œç¤¼ç‰©</div>
          </div>
          <div class="setting-arrow">â€º</div>
        </div>
      </div>
    </div>

    <!-- å…³äº -->
    <div class="settings-section">
      <div class="section-title">å…³äº</div>
      <div class="settings-list">
        <div class="setting-item" style="cursor: default;">
          <div class="setting-info">
            <div class="setting-label">ç‰ˆæœ¬ä¿¡æ¯</div>
            <div class="setting-desc">æ›¦æ–‡ç¤¼ç‰©å…‘æ¢ç³»ç»Ÿ v1.0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨èœå• -->
  <div class="parent-menu">
    <button class="menu-btn" onclick="window.location.href='parent-record.html'">å¿«é€Ÿè®°è´¦</button>
    <button class="menu-btn" onclick="window.location.href='parent-tasks.html'">ä»»åŠ¡ç®¡ç†</button>
    <button class="menu-btn" onclick="window.location.href='parent-gifts.html'">ç¤¼ç‰©ç®¡ç†</button>
    <button class="menu-btn" onclick="window.location.href='parent-approval.html'">å…‘æ¢å®¡æ‰¹</button>
  </div>

  <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
  <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

  <!-- Supabase å®¢æˆ·ç«¯åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabase é…ç½® -->
  <script src="js/supabase-config.js?v=1"></script>
  <script src="js/common.js?v=5"></script>
  <script>
    utils.requireParentMode();

    // åˆå§‹åŒ–
    function init() {
      updateStats();
      updateCloudSyncStatus();
    }

    // æ›´æ–°äº‘åŒæ­¥çŠ¶æ€
    function updateCloudSyncStatus() {
      const statusDesc = document.getElementById('cloudSyncDesc');
      const migrateBtn = document.getElementById('migrateToCloud');

      if (window.supabaseSync && window.supabaseSync.enabled) {
        statusDesc.textContent = 'äº‘åŒæ­¥å·²å¯ç”¨ - ç‚¹å‡»æ‰‹åŠ¨åŒæ­¥';
        statusDesc.style.color = 'var(--success-color)';

        // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æ•°æ®éœ€è¦è¿ç§»
        const hasLocalData = localStorage.getItem('xiwen_records') &&
                            JSON.parse(localStorage.getItem('xiwen_records')).length > 0;
        if (hasLocalData) {
          migrateBtn.style.display = 'flex';
        }
      } else {
        statusDesc.textContent = 'æœªé…ç½®äº‘åŒæ­¥ - ä»…ä½¿ç”¨æœ¬åœ°å­˜å‚¨';
        statusDesc.style.color = 'var(--text-light)';
        migrateBtn.style.display = 'none';
      }
    }

    // æ‰‹åŠ¨äº‘åŒæ­¥
    async function manualCloudSync() {
      if (!window.supabaseSync || !window.supabaseSync.enabled) {
        utils.showToast('äº‘åŒæ­¥æœªå¯ç”¨', 'warning');
        return;
      }

      utils.showToast('æ­£åœ¨åŒæ­¥...', 'info');
      const success = await window.supabaseSync.manualSync();

      if (success) {
        utils.showToast('åŒæ­¥æˆåŠŸï¼');
        updateStats();
      } else {
        utils.showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
      }
    }

    // è¿ç§»æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
    async function migrateLocalToCloud() {
      if (!window.supabaseSync || !window.supabaseSync.enabled) {
        utils.showToast('äº‘åŒæ­¥æœªå¯ç”¨', 'warning');
        return;
      }

      if (!confirm('ç¡®å®šè¦å°†æœ¬åœ°æ•°æ®ä¸Šä¼ åˆ°äº‘ç«¯å—ï¼Ÿ\n\nè¿™å°†æŠŠæ‰€æœ‰æœ¬åœ°ä»»åŠ¡ã€ç¤¼ç‰©ã€è®°å½•å’Œç”³è¯·ä¸Šä¼ åˆ°Supabaseã€‚')) {
        return;
      }

      utils.showToast('å¼€å§‹è¿ç§»æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');

      const result = await window.supabaseSync.migrateLocalToCloud();

      if (result.success) {
        utils.showToast(`æ•°æ®è¿ç§»å®Œæˆï¼å…±ä¸Šä¼  ${result.count} æ¡æ•°æ®`);
        document.getElementById('migrateToCloud').style.display = 'none';
      } else {
        utils.showToast('æ•°æ®è¿ç§»å¤±è´¥: ' + result.message, 'error');
      }
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      const records = dataManager.getRecords();
      const tasks = dataManager.getTasks();
      const gifts = dataManager.getGifts();
      const totalScore = dataManager.getTotalScore();

      document.getElementById('totalRecords').textContent = records.length;
      document.getElementById('totalTasks').textContent = tasks.length;
      document.getElementById('totalGifts').textContent = gifts.length;
      document.getElementById('totalScore').textContent = totalScore;
    }

    // æ˜¾ç¤ºç§¯åˆ†åˆå§‹åŒ–å¼¹çª—
    function showInitScoreModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <h3 class="modal-title">ç§¯åˆ†åˆå§‹åŒ–</h3>
          <p style="color: var(--text-medium); margin-bottom: var(--spacing-lg);">
            å°†çº¸è´¨è®°å½•çš„ç§¯åˆ†ä¸€æ¬¡æ€§å½•å…¥ç³»ç»Ÿã€‚è¿™ä¼šåˆ›å»ºä¸€æ¡ç‰¹æ®Šçš„åˆå§‹åŒ–è®°å½•ã€‚
          </p>
          <form id="initScoreForm" onsubmit="submitInitScore(event)">
            <div class="form-group">
              <label class="form-label form-label-required">åˆå§‹ç§¯åˆ†</label>
              <input type="number" class="input" id="initScore" placeholder="è¾“å…¥åˆå§‹ç§¯åˆ†å€¼" required>
            </div>

            <div class="form-group">
              <label class="form-label">å¤‡æ³¨è¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
              <textarea class="textarea" id="initNote" placeholder="ä¾‹å¦‚ï¼šä»çº¸è´¨è®°å½•è¿ç§»çš„ç§¯åˆ†" maxlength="200"></textarea>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary btn-half" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn-primary btn-half">ç¡®å®š</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    // æäº¤ç§¯åˆ†åˆå§‹åŒ–
    function submitInitScore(event) {
      event.preventDefault();

      const score = parseInt(document.getElementById('initScore').value);
      const note = document.getElementById('initNote').value.trim() || 'ç§¯åˆ†åˆå§‹åŒ–';

      utils.showConfirm(
        'ç¡®è®¤åˆå§‹åŒ–',
        `ç¡®å®šè¦æ·»åŠ ${score}åˆ†çš„åˆå§‹ç§¯åˆ†å—ï¼Ÿ`,
        () => {
          dataManager.addRecord({
            taskId: 0,
            taskName: 'ç§¯åˆ†åˆå§‹åŒ–',
            score: score,
            note: note
          });

          utils.showToast('ç§¯åˆ†åˆå§‹åŒ–æˆåŠŸï¼');
          updateStats();
          document.querySelector('.modal-overlay').remove();
        }
      );
    }

    // æ˜¾ç¤ºä¿®æ”¹PINç å¼¹çª—
    function showChangePinModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <h3 class="modal-title">ä¿®æ”¹PINç </h3>
          <form id="changePinForm" onsubmit="submitChangePin(event)">
            <div class="form-group">
              <label class="form-label form-label-required">å½“å‰PINç </label>
              <div class="pin-input-container">
                <input type="password" class="pin-input-dot" maxlength="1" id="oldPin0" oninput="moveFocus(this, 'oldPin1')">
                <input type="password" class="pin-input-dot" maxlength="1" id="oldPin1" oninput="moveFocus(this, 'oldPin2')">
                <input type="password" class="pin-input-dot" maxlength="1" id="oldPin2" oninput="moveFocus(this, 'oldPin3')">
                <input type="password" class="pin-input-dot" maxlength="1" id="oldPin3">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">æ–°PINç </label>
              <div class="pin-input-container">
                <input type="password" class="pin-input-dot" maxlength="1" id="newPin0" oninput="moveFocus(this, 'newPin1')">
                <input type="password" class="pin-input-dot" maxlength="1" id="newPin1" oninput="moveFocus(this, 'newPin2')">
                <input type="password" class="pin-input-dot" maxlength="1" id="newPin2" oninput="moveFocus(this, 'newPin3')">
                <input type="password" class="pin-input-dot" maxlength="1" id="newPin3">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label form-label-required">ç¡®è®¤æ–°PINç </label>
              <div class="pin-input-container">
                <input type="password" class="pin-input-dot" maxlength="1" id="confirmPin0" oninput="moveFocus(this, 'confirmPin1')">
                <input type="password" class="pin-input-dot" maxlength="1" id="confirmPin1" oninput="moveFocus(this, 'confirmPin2')">
                <input type="password" class="pin-input-dot" maxlength="1" id="confirmPin2" oninput="moveFocus(this, 'confirmPin3')">
                <input type="password" class="pin-input-dot" maxlength="1" id="confirmPin3">
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary btn-half" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn-primary btn-half">ç¡®å®š</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      // è‡ªåŠ¨èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
      setTimeout(() => document.getElementById('oldPin0').focus(), 100);

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    // è‡ªåŠ¨ç§»åŠ¨ç„¦ç‚¹
    function moveFocus(current, nextId) {
      if (current.value.length === 1) {
        const next = document.getElementById(nextId);
        if (next) next.focus();
      }
    }

    // è·å–PINç 
    function getPin(prefix) {
      let pin = '';
      for (let i = 0; i < 4; i++) {
        const input = document.getElementById(prefix + i);
        if (input && input.value) {
          pin += input.value;
        }
      }
      return pin;
    }

    // æäº¤ä¿®æ”¹PINç 
    function submitChangePin(event) {
      event.preventDefault();

      const oldPin = getPin('oldPin');
      const newPin = getPin('newPin');
      const confirmPin = getPin('confirmPin');

      if (oldPin.length !== 4 || newPin.length !== 4 || confirmPin.length !== 4) {
        utils.showToast('è¯·è¾“å…¥å®Œæ•´çš„PINç ', 'error');
        return;
      }

      if (!dataManager.verifyPin(oldPin)) {
        utils.showToast('å½“å‰PINç é”™è¯¯', 'error');
        return;
      }

      if (newPin !== confirmPin) {
        utils.showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°PINç ä¸ä¸€è‡´', 'error');
        return;
      }

      if (!/^\d{4}$/.test(newPin)) {
        utils.showToast('PINç å¿…é¡»æ˜¯4ä½æ•°å­—', 'error');
        return;
      }

      dataManager.changePin(newPin);
      utils.showToast('PINç ä¿®æ”¹æˆåŠŸï¼');
      document.querySelector('.modal-overlay').remove();
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
      const data = {
        tasks: dataManager.getTasks(),
        records: dataManager.getRecords(),
        gifts: dataManager.getGifts(),
        requests: dataManager.getRequests(),
        exportDate: new Date().toISOString(),
        version: '1.0'
      };

      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `xiwen-backup-${new Date().getTime()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      utils.showToast('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
    }

    // å¯¼å…¥æ•°æ®
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);

          utils.showConfirm(
            'ç¡®è®¤å¯¼å…¥',
            'å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ\n\nå»ºè®®å…ˆå¯¼å‡ºå½“å‰æ•°æ®å¤‡ä»½ã€‚',
            () => {
              if (data.tasks) localStorage.setItem('xiwen_tasks', JSON.stringify(data.tasks));
              if (data.records) localStorage.setItem('xiwen_records', JSON.stringify(data.records));
              if (data.gifts) localStorage.setItem('xiwen_gifts', JSON.stringify(data.gifts));
              if (data.requests) localStorage.setItem('xiwen_requests', JSON.stringify(data.requests));

              utils.showToast('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
              setTimeout(() => location.reload(), 1000);
            }
          );
        } catch (error) {
          utils.showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥', 'error');
        }
      };
      reader.readAsText(file);

      // é‡ç½®æ–‡ä»¶è¾“å…¥
      event.target.value = '';
    }

    // æ¸…ç©ºæ‰€æœ‰æ•°æ®
    async function clearAllData() {
      utils.showConfirm(
        'âš ï¸ å±é™©æ“ä½œ',
        'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æœ¬åœ°å’Œäº‘ç«¯çš„æ‰€æœ‰ä»»åŠ¡ã€è®°å½•ã€ç¤¼ç‰©å’Œç”³è¯·ï¼Œä¸”æ— æ³•æ¢å¤ï¼\n\nå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚',
        () => {
          utils.showConfirm(
            'âš ï¸ äºŒæ¬¡ç¡®è®¤',
            'çœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼',
            async () => {
              try {
                // æ¸…ç©ºæœ¬åœ°æ•°æ®
                localStorage.removeItem('xiwen_tasks');
                localStorage.removeItem('xiwen_records');
                localStorage.removeItem('xiwen_gifts');
                localStorage.removeItem('xiwen_requests');

                // æ¸…ç©ºäº‘ç«¯æ•°æ®ï¼ˆå¦‚æœäº‘åŒæ­¥å·²å¯ç”¨ï¼‰
                if (window.supabaseSync && window.supabaseSync.enabled) {
                  console.log('ğŸ—‘ï¸ æ­£åœ¨æ¸…ç©ºäº‘ç«¯æ•°æ®...');

                  const { error: recordsError } = await supabaseClient
                    .from('xiwen_records')
                    .delete()
                    .neq('id', 0); // åˆ é™¤æ‰€æœ‰è®°å½•

                  const { error: requestsError } = await supabaseClient
                    .from('xiwen_requests')
                    .delete()
                    .neq('id', 0); // åˆ é™¤æ‰€æœ‰å…‘æ¢ç”³è¯·

                  const { error: tasksError } = await supabaseClient
                    .from('xiwen_tasks')
                    .delete()
                    .neq('id', 0); // åˆ é™¤æ‰€æœ‰ä»»åŠ¡

                  const { error: giftsError } = await supabaseClient
                    .from('xiwen_gifts')
                    .delete()
                    .neq('id', 0); // åˆ é™¤æ‰€æœ‰ç¤¼ç‰©

                  if (recordsError || requestsError || tasksError || giftsError) {
                    console.error('æ¸…ç©ºäº‘ç«¯æ•°æ®æ—¶å‡ºç°é”™è¯¯:', {
                      recordsError,
                      requestsError,
                      tasksError,
                      giftsError
                    });
                    utils.showToast('æœ¬åœ°æ•°æ®å·²æ¸…ç©ºï¼Œä½†äº‘ç«¯æ•°æ®æ¸…ç©ºå¤±è´¥ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°', 'warning');
                  } else {
                    console.log('âœ… äº‘ç«¯æ•°æ®å·²æ¸…ç©º');
                    utils.showToast('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰');
                  }
                } else {
                  utils.showToast('æœ¬åœ°æ•°æ®å·²æ¸…ç©º');
                }

                setTimeout(() => location.reload(), 1500);
              } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                utils.showToast('æ¸…ç©ºæ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
              }
            }
          );
        }
      );
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    // æ˜¾ç¤ºåˆ é™¤è®°å½•å¼¹çª—
    function showDeleteRecordsModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width: 700px;">
          <h3 class="modal-title">åˆ é™¤è®°å½•</h3>

          <div class="form-group">
            <label class="form-label">é€‰æ‹©æ—¥æœŸ</label>
            <input type="date" class="input" id="deleteRecordsDate" onchange="loadDeleteRecords()">
          </div>

          <div id="deleteRecordsStats" style="display: none; padding: 15px; background: #e8f4fd; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
              <span>è®°å½•æ€»æ•°ï¼š</span>
              <span id="deleteStatsCount">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
              <span>æ­£å‘ç§¯åˆ†ï¼š</span>
              <span id="deleteStatsPositive" style="color: var(--success-color);">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
              <span>è´Ÿå‘ç§¯åˆ†ï¼š</span>
              <span id="deleteStatsNegative" style="color: var(--error-color);">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 16px;">
              <span>å½“æ—¥æ€»åˆ†ï¼š</span>
              <span id="deleteStatsTotal">0</span>
            </div>
          </div>

          <div id="deleteRecordsList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
            <div style="text-align: center; padding: 40px; color: var(--text-light);">è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹è®°å½•</div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary btn-half" onclick="this.closest('.modal-overlay').remove()">å…³é—­</button>
            <button type="button" class="btn-danger btn-half" id="deleteAllRecordsBtn" style="display: none;" onclick="deleteAllRecordsOfDate()">åˆ é™¤å½“å¤©æ‰€æœ‰è®°å½•</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);
      setTimeout(() => overlay.classList.add('show'), 10);

      // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
      const dateInput = document.getElementById('deleteRecordsDate');
      dateInput.value = new Date().toISOString().split('T')[0];
      loadDeleteRecords();

      overlay.onclick = (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
          setTimeout(() => overlay.remove(), 200);
        }
      };
    }

    let currentDeleteDate = null;
    let currentDeleteRecords = [];

    function loadDeleteRecords() {
      const dateInput = document.getElementById('deleteRecordsDate');
      currentDeleteDate = dateInput.value;

      if (!currentDeleteDate) {
        document.getElementById('deleteRecordsList').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹è®°å½•</div>';
        document.getElementById('deleteRecordsStats').style.display = 'none';
        document.getElementById('deleteAllRecordsBtn').style.display = 'none';
        return;
      }

      const allRecords = dataManager.getRecords();
      const targetDate = new Date(currentDeleteDate + 'T00:00:00');

      currentDeleteRecords = allRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate.toDateString() === targetDate.toDateString();
      });

      displayDeleteRecords();
    }

    function displayDeleteRecords() {
      const listContainer = document.getElementById('deleteRecordsList');
      const statsSection = document.getElementById('deleteRecordsStats');
      const deleteAllBtn = document.getElementById('deleteAllRecordsBtn');

      if (currentDeleteRecords.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">è¯¥æ—¥æœŸæ²¡æœ‰è®°å½•</div>';
        statsSection.style.display = 'none';
        deleteAllBtn.style.display = 'none';
        return;
      }

      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      let totalCount = currentDeleteRecords.length;
      let positiveScore = 0;
      let negativeScore = 0;

      currentDeleteRecords.forEach(record => {
        if (record.score > 0) {
          positiveScore += record.score;
        } else {
          negativeScore += record.score;
        }
      });

      let totalScore = positiveScore + negativeScore;

      // æ˜¾ç¤ºç»Ÿè®¡
      document.getElementById('deleteStatsCount').textContent = totalCount;
      document.getElementById('deleteStatsPositive').textContent = '+' + positiveScore;
      document.getElementById('deleteStatsNegative').textContent = negativeScore;
      document.getElementById('deleteStatsTotal').textContent = (totalScore >= 0 ? '+' : '') + totalScore;
      statsSection.style.display = 'block';
      deleteAllBtn.style.display = 'block';

      // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
      let html = '';
      currentDeleteRecords.forEach(record => {
        const recordDate = new Date(record.date);
        const dateStr = recordDate.toLocaleString('zh-CN', {
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });

        const scoreClass = record.score >= 0 ? 'positive' : 'negative';
        const scoreColor = record.score >= 0 ? 'var(--success-color)' : 'var(--error-color)';
        const scorePrefix = record.score >= 0 ? '+' : '';

        html += `
          <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div style="font-size: 12px; color: var(--text-medium); margin-bottom: 4px;">${dateStr}</div>
              <div style="font-size: 14px; font-weight: 500;">${record.taskName}${record.note ? ' - ' + record.note : ''}</div>
            </div>
            <div style="font-size: 16px; font-weight: 600; color: ${scoreColor}; margin-right: 10px;">${scorePrefix}${record.score}</div>
            <button onclick="deleteSingleRecord(${record.id})" style="padding: 6px 12px; background: var(--error-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">åˆ é™¤</button>
          </div>
        `;
      });

      listContainer.innerHTML = html;
    }

    async function deleteSingleRecord(recordId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        return;
      }

      try {
        // ä½¿ç”¨ dataManager çš„åˆ é™¤æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
        await dataManager.deleteRecord(recordId);

        utils.showToast('è®°å½•å·²åˆ é™¤');
        loadDeleteRecords();
        updateStats();
      } catch (error) {
        console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
        utils.showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…', 'error');
      }
    }

    async function deleteAllRecordsOfDate() {
      if (!currentDeleteDate) return;

      const count = currentDeleteRecords.length;
      if (count === 0) return;

      if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${currentDeleteDate} çš„æ‰€æœ‰ ${count} æ¡è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }

      let successCount = 0;
      let failCount = 0;

      // é€æ¡åˆ é™¤è®°å½•ï¼ˆä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ï¼‰
      for (const record of currentDeleteRecords) {
        try {
          await dataManager.deleteRecord(record.id);
          successCount++;
        } catch (error) {
          console.error(`åˆ é™¤è®°å½• ${record.id} å¤±è´¥:`, error);
          failCount++;
        }
      }

      if (failCount > 0) {
        utils.showToast(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${failCount} æ¡ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°`, 'warning');
      } else {
        utils.showToast(`å·²åˆ é™¤ ${count} æ¡è®°å½•`);
      }

      loadDeleteRecords();
      updateStats();
    }

    init();
  </script>
</body>
</html>
